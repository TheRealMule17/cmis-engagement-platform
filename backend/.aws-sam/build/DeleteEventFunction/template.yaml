AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS SAM template for CMIS Event Management System

Globals:
  Function:
    Timeout: 30
    MemorySize: 256
    Runtime: nodejs18.x
    Architectures:
      - x86_64

Resources:
  # DynamoDB Tables (Existing)
  EventsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub CMIS-Events-${AWS::StackName}
      AttributeDefinitions:
        - AttributeName: EventID
          AttributeType: S
        - AttributeName: Status
          AttributeType: S
        - AttributeName: Date
          AttributeType: S
      KeySchema:
        - AttributeName: EventID
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: StatusDateIndex
          KeySchema:
            - AttributeName: Status
              KeyType: HASH
            - AttributeName: Date
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Project
          Value: CMIS
        - Key: Team
          Value: 12thMan

  RSVPsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub CMIS-RSVPs-${AWS::StackName}
      AttributeDefinitions:
        - AttributeName: EventID
          AttributeType: S
        - AttributeName: UserID
          AttributeType: S
      KeySchema:
        - AttributeName: EventID
          KeyType: HASH
        - AttributeName: UserID
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: UserID-index
          KeySchema:
            - AttributeName: UserID
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: Project
          Value: CMIS
        - Key: Team
          Value: 12thMan

  # Waitlist: PK EventID, SK JoinedAtUserID (JoinedAt#UserID for FIFO order per event)
  WaitlistTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub CMIS-Waitlist-${AWS::StackName}
      AttributeDefinitions:
        - AttributeName: EventID
          AttributeType: S
        - AttributeName: JoinedAtUserID
          AttributeType: S
      KeySchema:
        - AttributeName: EventID
          KeyType: HASH
        - AttributeName: JoinedAtUserID
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: Project
          Value: CMIS
        - Key: Team
          Value: 12thMan

  # Past events (partition by YearMonth for efficient query); never delete - archive only
  PastEventsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub CMIS-PastEvents-${AWS::StackName}
      AttributeDefinitions:
        - AttributeName: YearMonth
          AttributeType: S
        - AttributeName: DateEventID
          AttributeType: S
      KeySchema:
        - AttributeName: YearMonth
          KeyType: HASH
        - AttributeName: DateEventID
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: Project
          Value: CMIS
        - Key: Team
          Value: 12thMan

  # FIFO queue for waitlist processing (one promotion per message, ordered per event)
  WaitlistQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub CMIS-WaitlistQueue-${AWS::StackName}.fifo
      FifoQueue: true
      ContentBasedDeduplication: false
      MessageRetentionPeriod: 86400
      VisibilityTimeout: 60

  # API Gateway
  CMISEventsAPI:
    Type: AWS::Serverless::Api
    Properties:
      Name: CMISEventsAPI
      StageName: prod
      Cors:
        AllowOrigin: "'*'"
        AllowHeaders: "'Content-Type,Authorization'"
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      Auth: 
        DefaultAuthorizer: NONE # We'll add Cognito later

  # Lambda Functions
  GetEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/getEvents.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref EventsTable
      Events:
        GetEvents:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events
            Method: GET

  GetPastEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/getPastEvents.handler
      Environment:
        Variables:
          PAST_EVENTS_TABLE_NAME: !Ref PastEventsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref PastEventsTable
      Events:
        GetPastEvents:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events/past
            Method: GET

  ArchivePastEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/archivePastEvents.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
          PAST_EVENTS_TABLE_NAME: !Ref PastEventsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EventsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref PastEventsTable
      Events:
        DailyArchive:
          Type: Schedule
          Properties:
            Schedule: "cron(0 2 * * ? *)"
            Description: Archive past events daily (2 AM UTC)
            Enabled: true

  CreateEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/createEvent.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EventsTable
      Events:
        CreateEvent:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events
            Method: POST

  GetEventByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/getEventById.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
          RSVPS_TABLE_NAME: !Ref RSVPsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref EventsTable
        - DynamoDBReadPolicy:
            TableName: !Ref RSVPsTable
      Events:
        GetEventById:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events/{id}
            Method: GET

  UpdateEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/updateEvent.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EventsTable
      Events:
        UpdateEvent:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events/{id}
            Method: PUT

  DeleteEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/deleteEvent.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EventsTable
      Events:
        DeleteEvent:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events/{id}
            Method: DELETE

  RsvpEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/rsvpEvent.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
          RSVPS_TABLE_NAME: !Ref RSVPsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EventsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref RSVPsTable
      Events:
        RsvpEvent:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events/{id}/rsvp
            Method: POST

  CancelRsvpFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/cancelRsvp.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
          RSVPS_TABLE_NAME: !Ref RSVPsTable
          WAITLIST_TABLE_NAME: !Ref WaitlistTable
          WAITLIST_QUEUE_URL: !Ref WaitlistQueue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EventsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref RSVPsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref WaitlistTable
        - Statement:
            - Effect: Allow
              Action: sqs:SendMessage
              Resource: !GetAtt WaitlistQueue.Arn
      Events:
        CancelRsvp:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events/{id}/rsvp
            Method: DELETE

  JoinWaitlistFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/joinWaitlist.handler
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
          WAITLIST_TABLE_NAME: !Ref WaitlistTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref EventsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref WaitlistTable
      Events:
        JoinWaitlist:
          Type: Api
          Properties:
            RestApiId: !Ref CMISEventsAPI
            Path: /events/{id}/waitlist
            Method: POST

  ProcessWaitlistFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/lambdas/processWaitlist.handler
      Timeout: 60
      Environment:
        Variables:
          EVENTS_TABLE_NAME: !Ref EventsTable
          RSVPS_TABLE_NAME: !Ref RSVPsTable
          WAITLIST_TABLE_NAME: !Ref WaitlistTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EventsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref RSVPsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref WaitlistTable
      Events:
        WaitlistQueueTrigger:
          Type: SQS
          Properties:
            Queue: !GetAtt WaitlistQueue.Arn
            BatchSize: 1

Outputs:
  ApiGatewayUrl:
    Description: API Gateway URL for Prod Stage
    Value: !Sub "https://${CMISEventsAPI}.execute-api.${AWS::Region}.amazonaws.com/prod/"
  EventsTableName:
    Description: Name of the Events DynamoDB table
    Value: !Ref EventsTable
  RSVPsTableName:
    Description: Name of the RSVPs DynamoDB table
    Value: !Ref RSVPsTable
